<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>FocusFlow | Habit & Routine Tracker</title>
  <link rel="stylesheet" href="/style.css" />
</head>
<body>
  <header class="site-header">
    <nav class="nav">
      <a class="nav__brand" href="/">FocusFlow</a>
      <div class="nav__links">
        <a href="/">Home</a>
        <a href="/about">About</a>
        <a href="/contact">Contact</a>
        <a href="/search">Search</a>
      </div>
    </nav>
  </header>

  <main class="container">
    <section class="hero-section">
      <h1>FocusFlow</h1>
      <p class="subtitle">Track your habits and routines with clear weekly insights</p>
    </section>

    <!-- Create Habit Form -->
    <section class="card">
      <h2 id="form-title">Create New Habit</h2>
      <form id="habit-form" class="habit-form">
        <input type="hidden" id="habit-id" name="id" />
        <div class="form-group">
          <label for="title">Title *</label>
          <input type="text" id="title" name="title" required placeholder="e.g., Morning Exercise" />
        </div>
        <div class="form-group">
          <label for="description">Description *</label>
          <textarea id="description" name="description" required rows="3" placeholder="e.g., 30 minutes of cardio every morning"></textarea>
        </div>
        <div class="form-actions">
          <button type="submit" class="button primary" id="submit-btn">Create Habit</button>
          <button type="button" class="button ghost" id="cancel-btn" style="display: none;" onclick="cancelEdit()">Cancel</button>
        </div>
      </form>
    </section>

    <!-- Habits Table/Catalog -->
    <section class="card">
      <h2>My Habits</h2>
      <div id="loading" class="loading">Loading habits...</div>
      <div id="error-message" class="error-message" style="display: none;"></div>
      <div id="habits-container">
        <table class="habits-table" id="habits-table" style="display: none;">
          <thead>
            <tr>
              <th>ID</th>
              <th>Title</th>
              <th>Description</th>
              <th>Created</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="habits-tbody">
            <!-- Habits will be loaded here dynamically -->
          </tbody>
        </table>
        <div id="empty-state" class="empty-state" style="display: none;">
          <p>No habits yet. Create your first habit above!</p>
        </div>
      </div>
    </section>
  </main>

  <footer class="footer">
    <p>FocusFlow • Habit Tracker • Assignment 3 Part 2</p>
  </footer>

  <script>
    // Load habits on page load
    document.addEventListener('DOMContentLoaded', () => {
      loadHabits();
    });

    // Handle form submission
    document.getElementById('habit-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const formData = {
        title: document.getElementById('title').value.trim(),
        description: document.getElementById('description').value.trim()
      };

      const habitId = document.getElementById('habit-id').value;
      const submitBtn = document.getElementById('submit-btn');
      const originalText = submitBtn.textContent;

      try {
        submitBtn.disabled = true;
        submitBtn.textContent = 'Saving...';

        let response;
        if (habitId) {
          // Update existing habit
          response = await fetch(`/api/habits/${habitId}`, {
            method: 'PUT',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(formData)
          });
        } else {
          // Create new habit
          response = await fetch('/api/habits', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(formData)
          });
        }

        if (response.ok) {
          document.getElementById('habit-form').reset();
          document.getElementById('habit-id').value = '';
          document.getElementById('form-title').textContent = 'Create New Habit';
          document.getElementById('submit-btn').textContent = 'Create Habit';
          document.getElementById('cancel-btn').style.display = 'none';
          loadHabits();
          showMessage('Habit saved successfully!', 'success');
        } else {
          const error = await response.json();
          showMessage(error.error || 'Failed to save habit', 'error');
        }
      } catch (error) {
        console.error('Error:', error);
        showMessage('An error occurred. Please try again.', 'error');
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = originalText;
      }
    });

    // Load all habits from API
    async function loadHabits() {
      const loading = document.getElementById('loading');
      const table = document.getElementById('habits-table');
      const emptyState = document.getElementById('empty-state');
      const errorMessage = document.getElementById('error-message');
      const tbody = document.getElementById('habits-tbody');

      try {
        loading.style.display = 'block';
        table.style.display = 'none';
        emptyState.style.display = 'none';
        errorMessage.style.display = 'none';

        const response = await fetch('/api/habits');
        
        if (!response.ok) {
          throw new Error('Failed to load habits');
        }

        const habits = await response.json();
        loading.style.display = 'none';

        if (habits.length === 0) {
          emptyState.style.display = 'block';
        } else {
          tbody.innerHTML = '';
          habits.forEach(habit => {
            const row = createHabitRow(habit);
            tbody.appendChild(row);
          });
          table.style.display = 'table';
        }
      } catch (error) {
        console.error('Error loading habits:', error);
        loading.style.display = 'none';
        errorMessage.textContent = 'Failed to load habits. Please refresh the page.';
        errorMessage.style.display = 'block';
      }
    }

    // Create a table row for a habit
    function createHabitRow(habit) {
      const row = document.createElement('tr');
      
      const createdDate = habit.created_at 
        ? new Date(habit.created_at).toLocaleDateString() 
        : 'N/A';

      row.innerHTML = `
        <td>${habit.id}</td>
        <td><strong>${escapeHtml(habit.title)}</strong></td>
        <td>${escapeHtml(habit.description)}</td>
        <td>${createdDate}</td>
        <td class="actions-cell">
          <button class="button small edit-btn" onclick="editHabit(${habit.id})">Edit</button>
          <button class="button small delete-btn" onclick="deleteHabit(${habit.id})">Delete</button>
        </td>
      `;
      
      return row;
    }

    // Edit a habit
    async function editHabit(id) {
      try {
        const response = await fetch(`/api/habits/${id}`);
        if (!response.ok) {
          throw new Error('Failed to load habit');
        }

        const habit = await response.json();
        
        document.getElementById('habit-id').value = habit.id;
        document.getElementById('title').value = habit.title;
        document.getElementById('description').value = habit.description;
        document.getElementById('form-title').textContent = 'Edit Habit';
        document.getElementById('submit-btn').textContent = 'Update Habit';
        document.getElementById('cancel-btn').style.display = 'inline-block';
        
        // Scroll to form
        document.getElementById('habit-form').scrollIntoView({ behavior: 'smooth', block: 'start' });
      } catch (error) {
        console.error('Error loading habit:', error);
        showMessage('Failed to load habit for editing', 'error');
      }
    }

    // Cancel edit mode
    function cancelEdit() {
      document.getElementById('habit-form').reset();
      document.getElementById('habit-id').value = '';
      document.getElementById('form-title').textContent = 'Create New Habit';
      document.getElementById('submit-btn').textContent = 'Create Habit';
      document.getElementById('cancel-btn').style.display = 'none';
    }

    // Delete a habit
    async function deleteHabit(id) {
      if (!confirm('Are you sure you want to delete this habit?')) {
        return;
      }

      try {
        const response = await fetch(`/api/habits/${id}`, {
          method: 'DELETE'
        });

        if (response.ok) {
          loadHabits();
          showMessage('Habit deleted successfully!', 'success');
        } else {
          const error = await response.json();
          showMessage(error.error || 'Failed to delete habit', 'error');
        }
      } catch (error) {
        console.error('Error deleting habit:', error);
        showMessage('An error occurred. Please try again.', 'error');
      }
    }

    // Show message to user
    function showMessage(message, type) {
      // Create or update message element
      let messageEl = document.getElementById('flash-message');
      if (!messageEl) {
        messageEl = document.createElement('div');
        messageEl.id = 'flash-message';
        messageEl.className = `flash-message ${type}`;
        document.querySelector('.container').insertBefore(messageEl, document.querySelector('.container').firstChild);
      }
      
      messageEl.textContent = message;
      messageEl.className = `flash-message ${type}`;
      messageEl.style.display = 'block';
      
      // Hide after 3 seconds
      setTimeout(() => {
        messageEl.style.display = 'none';
      }, 3000);
    }

    // Escape HTML to prevent XSS
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
  </script>
</body>
</html>
